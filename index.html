<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html charset=utf-8">
</head>

<body>

  <!-- Create the canvas that the C++ code will draw into -->
  <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>

  <!-- Allow the C++ to access the canvas element --> 
  <script type='text/javascript'>
    const canvasEl = document.getElementById('canvas')
    var Module = {
      canvas: canvasEl
    }
  </script>
  
  <!-- Call the javascript glue code (index.js) as generated by Emscripten -->
  <script src="output/index.js"></script>

  <!-- Main -->
  <script type='text/javascript'>
    canvasEl.addEventListener('click', _CPP_onClick, false)
    canvasEl.addEventListener('touchend', _CPP_onClick, false)

    async function loadFile(src) {
      const blob = await fetch(src).then(resp => resp.blob())
      const pointer = _CPP_createBuffer(blob.size)
      const buffer = await blob.arrayBuffer()

      const data = new Uint8ClampedArray(buffer)
      Module.HEAP8.set(data, pointer)

      return pointer
    }

    async function loadAssets() {
      // Load assets
      const aerowalkPointer = await loadFile("./data/aerowalk.bsp")
      _CPP_setCurrentMap(aerowalkPointer)

      const vertShader = await loadFile("./shader/test.vert")
      const fragShader = await loadFile("./shader/test.frag")
      const success = _CPP_createShaderProgram(0, vertShader, fragShader)
      if (success) {
        _CPP_start()
      } else {
        console.error('failed to create shader program')
      }
    }

    loadAssets();

    function testGlobalJS() {
      console.warn("JS called from JS")
    }
  </script>

  <!-- Thank you Tim Hutton! https://github.com/timhutton/opengl-canvas-wasm -->

</body>

</html>
